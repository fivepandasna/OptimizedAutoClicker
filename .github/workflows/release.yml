name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Extract version from tag
      id: get_version
      shell: bash
      run: |
        echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Create build directories
      shell: bash
      run: |
        mkdir -p build/app
        mkdir -p build/installer

    - name: Compile application
      shell: cmd
      run: |
        rc /nologo /fo build\resource.res src\resource.rc
        cl src\OptimizedAutoClicker.cpp build\resource.res ^
          /Fe:build\app\OptimizedAutoClicker.exe ^
          /EHsc /O2 /MT ^
          /DUNICODE /D_UNICODE ^
          /link user32.lib gdi32.lib comctl32.lib shell32.lib ^
          /SUBSYSTEM:WINDOWS

    - name: Verify build output
      shell: bash
      run: |
        if [ ! -f "build/app/OptimizedAutoClicker.exe" ]; then
          echo "Error: OptimizedAutoClicker.exe not found!"
          exit 1
        fi
        ls -lh build/app/

    - name: Install Inno Setup
      shell: powershell
      run: |
        choco install innosetup -y

    - name: Build installer
      shell: cmd
      run: |
        "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" ^
          /DMyAppVersion=${{ steps.get_version.outputs.VERSION }} ^
          setup.iss

    - name: Verify installer output
      shell: bash
      run: |
        ls -lh build/installer/
        ls build/installer/OptimizedAutoClicker-Setup-*.exe >/dev/null 2>&1 || {
          echo "Error: Installer not found!"
          exit 1
        }

    - name: Generate checksums
      shell: bash
      run: |
        sha256sum build/app/OptimizedAutoClicker.exe > checksums.txt
        sha256sum build/installer/*.exe >> checksums.txt
        cat checksums.txt

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        draft: true
        prerelease: false
        files: |
          build/app/OptimizedAutoClicker.exe
          build/installer/*.exe
          checksums.txt
        body: |
          ## Optimized AutoClicker ${{ github.ref_name }}

          ### Installation (Recommended)
          Download and run:
          **OptimizedAutoClicker-Setup-${{ steps.get_version.outputs.VERSION }}.exe**

          ### Standalone
          Use **OptimizedAutoClicker.exe** if you prefer a portable version.

          ### Features
          - High-performance auto-clicking
          - Customizable intervals (hours/mins/secs/ms)
          - Random offset for human-like behavior
          - Configurable hotkey
          - Modern dark UI

          ### Checksums
          SHA256 checksums are provided for verification.

          ### Changelog
          See commits since the previous release for details.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
